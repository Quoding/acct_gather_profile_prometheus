/*
* @author Alexandre Larouche (alexandre.larouche@calculquebec.ca)
*
* This is a draft version of the guide, in no way official !
*
* Slurm Profiling Plugin Programming 101 (SPPP-101)
* Description:
* Court guide sur comment programmer un plugin de profilage avec Slurm
* //
* Short guide on how to program a profiling pluging with Slurm
*/


Slurm Profiling Plugin Programming 101 (SPPP-101):

POURQUOI FAIRE UN PLUGIN SLURM ? {anchor}

Il peut être utile de faire un plugin de profilage Slurm lorsque vous voulez faire
usage de la capacité de profilage de Slurm afin de voir le comportement de certaines
tâches. Slurm supporte plusieurs types de profilage, soit filesystem(lustre), task,
energy et network(infiniband). Faire un plugin avec Slurm directement veut également
dire que vous n'avez pas à gérer la gymnastique de savoir quels coeurs/noeuds ont
été attribués à quelle tâche - Slurm le fait pour vous.

COMMENT FAIRE UN PLUGIN SLURM ? {anchor}

1 - Identifier ses besoins (e.g. Pourquoi faire un plugin ? 
    Qu'est-ce que je vais plug in (Prometheus, Elasticsearch, etc.)?, ...)

2 - Verifier si un plugin similaire existe (e.g. InfluxDB et Prometheus
    ont des push reseaux) déjà. Si oui, il est peut-être possible de 
    récupérer une partie du code et le modifier afin de le faire fonctionner
    avec votre idée.

3 - Si aucun plugin similaire existe, armez-vous de patience et du plugin vide (none):
    https://github.com/SchedMD/slurm/tree/master/src/plugins/acct_gather_profile


Bien que le plugin none soit vide, il est possible pour vous d'aller chercher la
mécanique qui va chercher les données dans Slurm (qui reste grossièrement similaire
d'un plugin à un autre). Souvent, ce qui risque de changer dans plugin se trouve dans la 
fonction  *acct_gather_profile_p_add_sample_data()*. C'est cette fonction qui extrait
les données de Slurm et les envoie ou les ajoute à un conteneur.

Le plugin HDF5 est une bonne base si ce que vous voulez est écrire dans un fichier.
Le plugin InfluxDB et Prometheus sont de bons exemples si vous cherchez à envoyer
les données sur le réseaux / à un serveur.

Afin de pouvoir compiler le nouveau plugin, il est recommandé de passer par le make
de Slurm directement (ce qui implique d'avoir le code source de Slurm de la version qui
roule sur votre cluster). Il faut donc modifier la configuration afin de parvenir à 
compiler le plugin.

1 - Ouvrir `configure.ac` à la racine du projet
2 - Chercher acct_gather_profile/none
3 - Copier/coller cette ligne une fois
4 - Change le none dans cette nouvelle ligne par prometheus
5 - Sauvegarder et quitter
6 - Ouvrir src/plugins/acct_gather_profile/Makefile.am
7 - À coté de "none" ajouter "prometheus"
8 - Sauvegarder et quitter
9 - Faire une copie du répertoire src/plugins/acct_gather_profile/none et renommer
    cette copie ainsi que le .c à l'intérieur par le nom du plugin.
10 - Ouvrir le fichier src/plugins/acct_gather_profile/$NOMDUPLUGIN/Makefile.am
11 - Changer tous les "none" par $NOMDUPLUGIN
12 - Retourner à la racine du projet et appeler ./autogen.sh

N'oubliez pas d'appeler le configure avant le make.

Si vous utilisez des librairies qui ont besoin d'être liées, n'oubliez pas de le faire
dans le Makefile.am du répertoire de votre plugin. (Il peut être utile de se réferer
au Makefile.am des autres plugins4)

Votre plugin compilé se trouvera dans le répertoire .libs dans le répertoire de votre plugin
- il vous suffit de le copier dans le répertoire de librairies de votre installation
Slurm.(/opt/software/slurm/lib64/slurm/, par exemple)

Sources :
https://slurm.schedmd.com/hdf5_profile_user_guide.html
Félix-Antoine Fortin
https://github.com/SchedMD/slurm
https://slurm.schedmd.com/acct_gather_profile_plugins.html
